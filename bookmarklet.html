<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>競馬データ抽出Bookmarklet - Race DB App</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      color: #333;
      background-color: #f8f9fa;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #007bff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 28px;
    }
    h2 {
      color: #495057;
      border-bottom: 2px solid #007bff;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    .bookmarklet {
      background-color: #e8f4fd;
      border: 2px solid #007bff;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }
    .bookmarklet-link {
      display: inline-block;
      background-color: #007bff;
      color: white;
      padding: 15px 30px;
      text-decoration: none;
      border-radius: 8px;
      font-weight: bold;
      font-size: 16px;
      cursor: grab;
      transition: background-color 0.3s;
    }
    .bookmarklet-link:hover {
      background-color: #0056b3;
    }
    .step {
      background-color: #f8f9fa;
      border-left: 4px solid #28a745;
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 8px 8px 0;
    }
    .step h3 {
      margin-top: 0;
      color: #28a745;
    }
    .warning {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
    }
    .warning h3 {
      color: #856404;
      margin-top: 0;
    }
    .code {
      background-color: #f1f3f4;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 15px;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin: 15px 0;
    }
    .back-link {
      text-align: center;
      margin-top: 30px;
    }
    .back-link a {
      color: #007bff;
      text-decoration: none;
      font-weight: bold;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔖 競馬データ抽出Bookmarklet</h1>
    
    <p>netkeibaのレースページから競馬データを簡単に抽出できるBookmarkletです。<br>
    ブラウザのブックマークバーにドラッグ&ドロップして設置してください。</p>

    <div class="warning">
      <h3>⚠️ 重要な注意事項</h3>
      <ul>
        <li><strong>個人利用・研究用途に限定</strong>してください</li>
        <li><strong>商用利用は禁止</strong>されています</li>
        <li>過度な連続実行は避け、<strong>適度な間隔</strong>を開けて使用してください</li>
        <li>netkeibaの利用規約を遵守してください</li>
      </ul>
    </div>

    <h2>📥 Bookmarklet設置</h2>
    
    <div class="bookmarklet">
      <p><strong>下のリンクをブックマークバーにドラッグ&ドロップしてください</strong></p>
      
      <!-- 通常版Bookmarklet -->
      <a href="javascript:(function(){try{const raceTitle=document.querySelector('.RaceName')?.textContent?.trim()||'';const raceData01=document.querySelector('.RaceData01')?.textContent?.trim()||'';const raceData02=document.querySelector('.RaceData02')?.textContent?.trim()||'';const horses=[];document.querySelectorAll('.Shutuba_Table tbody tr').forEach(row=>{const cells=row.querySelectorAll('td');if(cells.length>=11){const frameNumber=parseInt(cells[0]?.textContent?.trim())||0;const horseNumber=parseInt(cells[1]?.textContent?.trim())||0;const horseName=cells[3]?.querySelector('a')?.textContent?.trim()||cells[3]?.textContent?.trim()||'';const sexAge=cells[4]?.textContent?.trim()||'';const weight=parseFloat(cells[5]?.textContent?.trim())||0;const jockey=cells[6]?.querySelector('a')?.textContent?.trim()||cells[6]?.textContent?.trim()||'';if(horseName){horses.push({frameNumber,horseNumber,name:horseName,sex:sexAge.match(/([牡牝セ])/)?.[1]||'',age:parseInt(sexAge.match(/(\d+)/)?.[1])||0,weight,jockey,odds:0,popularity:0});}}});const data={raceTitle,raceData01,raceData02,horses};navigator.clipboard.writeText(JSON.stringify(data)).then(()=>{alert(`データを抽出しました！\nレース: ${raceTitle}\n馬数: ${horses.length}頭\n\nクリップボードにコピーしたので、アプリで貼り付けてください。`);})}catch(error){alert('データ抽出に失敗しました: '+error.message);}})()" 
           class="bookmarklet-link">
        🏇 netkeibaデータ抽出（通常版）
      </a>
      
      <br><br>
      
      <!-- デバッグ版Bookmarklet -->
      <a href="javascript:(function(){console.log('🚀 Bookmarklet開始！');alert('Bookmarklet開始！コンソールを確認してください');try{console.log('📄 ページURL:', window.location.href);const raceTitle=document.querySelector('.RaceName')?.textContent?.trim()||'';const raceData01=document.querySelector('.RaceData01')?.textContent?.trim()||'';const raceData02=document.querySelector('.RaceData02')?.textContent?.trim()||'';console.log('🏇 レース名:', raceTitle);console.log('📊 レースデータ01:', raceData01);console.log('📊 レースデータ02:', raceData02);const horses=[];const tableRows=document.querySelectorAll('.Shutuba_Table tbody tr');console.log('📋 見つかったテーブル行数:', tableRows.length);tableRows.forEach((row,index)=>{const cells=row.querySelectorAll('td');console.log(`🐎 馬${index+1}: セル数=${cells.length}`);if(cells.length>=11){const frameNumber=parseInt(cells[0]?.textContent?.trim())||0;const horseNumber=parseInt(cells[1]?.textContent?.trim())||0;const horseName=cells[3]?.querySelector('a')?.textContent?.trim()||cells[3]?.textContent?.trim()||'';console.log(`  枠${frameNumber}_馬${horseNumber}: ${horseName}`);if(horseName){horses.push({frameNumber,horseNumber,name:horseName,sex:'',age:0,weight:0,jockey:'',odds:0,popularity:0});}}});console.log('✅ 抽出完了:', horses.length+'頭');alert(`デバッグ完了！\n馬数: ${horses.length}頭\nコンソールで詳細を確認してください`);}catch(error){console.error('❌ エラー:', error);alert('エラー: '+error.message);}})()" 
           class="bookmarklet-link" style="background-color: #dc3545;">
        🔍 デバッグ版（テスト用）
      </a>
    </div>

    <h2>📋 使用方法</h2>
    
    <div class="step">
      <h3>ステップ 1: Bookmarklet設置</h3>
      <p>上のリンクをブラウザのブックマークバーにドラッグ&ドロップしてください。</p>
    </div>

    <div class="step">
      <h3>ステップ 2: netkeibaページを開く</h3>
      <p>netkeibaのレースページ（出馬表ページ）を開いてください。<br>
      例: <code>https://race.netkeiba.com/race/shutuba.html?race_id=...</code></p>
    </div>

    <div class="step">
      <h3>ステップ 3: Bookmarklet実行</h3>
      <p>ブックマークバーの「🏇 netkeibaデータ抽出」をクリックしてください。<br>
      データが抽出され、クリップボードにコピーされます。</p>
    </div>

    <div class="step">
      <h3>ステップ 4: アプリで貼り付け</h3>
      <p>Race DB Appの「Bookmarklet データ入力」セクションにJSONデータを貼り付けて、<br>
      「📊 データを入力」ボタンをクリックしてください。</p>
    </div>

    <h2>🔧 技術詳細</h2>
    
    <p>Bookmarkletは以下のデータを抽出します：</p>
    <ul>
      <li><strong>レース情報</strong>: レース名、距離、馬場、コース</li>
      <li><strong>馬データ</strong>: 枠番、馬番、馬名、性別、年齢、斤量、騎手</li>
    </ul>

    <details>
      <summary><strong>Bookmarkletソースコード（参考）</strong></summary>
      <div class="code">
javascript:(function(){
  try {
    // レース基本情報を抽出
    const raceTitle = document.querySelector('.RaceName')?.textContent?.trim() || '';
    const raceData01 = document.querySelector('.RaceData01')?.textContent?.trim() || '';
    const raceData02 = document.querySelector('.RaceData02')?.textContent?.trim() || '';
    
    // 馬データを抽出
    const horses = [];
    document.querySelectorAll('.Shutuba_Table tbody tr').forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length >= 11) {
        const frameNumber = parseInt(cells[0]?.textContent?.trim()) || 0;
        const horseNumber = parseInt(cells[1]?.textContent?.trim()) || 0;
        const horseName = cells[3]?.querySelector('a')?.textContent?.trim() || 
                         cells[3]?.textContent?.trim() || '';
        const sexAge = cells[4]?.textContent?.trim() || '';
        const weight = parseFloat(cells[5]?.textContent?.trim()) || 0;
        const jockey = cells[6]?.querySelector('a')?.textContent?.trim() || 
                      cells[6]?.textContent?.trim() || '';
        
        // オッズと人気を取得（IDベースで検索）
        let oddsText = cells[9]?.textContent?.trim() || '';
        let popularityText = cells[10]?.textContent?.trim() || '';
        
        // ID パターンからオッズと人気を探す試行
        const frameStr = String(frameNumber);
        const horseStr = String(horseNumber).toString().padStart(2, '0');
        
        // odds-{枠}_{馬番} パターンでオッズを検索
        const oddsId = `odds-${frameStr}_${horseStr}`;
        const popularityId = `ninki-${frameStr}_${horseStr}`;
        
        console.log(`🔍 Bookmarklet Debug: 枠${frameNumber}_馬${horseNumber} 検索中...`);
        console.log(`🆔 検索ID: オッズ="${oddsId}", 人気="${popularityId}"`);
        
        const oddsElement = document.getElementById(oddsId);
        const popularityElement = document.getElementById(popularityId);
        
        console.log(`🔍 要素発見: オッズ=${oddsElement ? 'あり' : 'なし'}, 人気=${popularityElement ? 'あり' : 'なし'}`);
        
        if (oddsElement) {
          const dynamicOdds = oddsElement.textContent.trim();
          console.log(`💰 オッズ要素内容: "${dynamicOdds}"`);
          if (dynamicOdds && dynamicOdds !== '---.-' && dynamicOdds !== '**') {
            oddsText = dynamicOdds;
            console.log(`✅ オッズ取得成功: ${dynamicOdds}`);
          }
        } else {
          console.log(`❌ オッズ要素が見つかりません: ${oddsId}`);
        }
        
        if (popularityElement) {
          const dynamicPopularity = popularityElement.textContent.trim();
          console.log(`🏆 人気要素内容: "${dynamicPopularity}"`);
          if (dynamicPopularity && dynamicPopularity !== '**' && dynamicPopularity !== '--') {
            popularityText = dynamicPopularity;
            console.log(`✅ 人気取得成功: ${dynamicPopularity}`);
          }
        } else {
          console.log(`❌ 人気要素が見つかりません: ${popularityId}`);
        }
        
        // 他の可能性のあるセレクターも試行（最初の馬のみ）
        if ((!oddsElement || oddsText === '---.-') && horseNumber === 1) {
          console.log('🔍 他のオッズ要素を探索中...');
          const allOddsElements = document.querySelectorAll('[id*="odds"]');
          console.log(`🎯 見つかったオッズ関連要素: ${allOddsElements.length}個`);
          allOddsElements.forEach((el, idx) => {
            console.log(`  [${idx}] ID: ${el.id}, 内容: "${el.textContent.trim()}"`);
          });
        }
        
        // オッズと人気の値をパース（レース前は0にする）
        let odds = 0;
        let popularity = 0;
        
        if (oddsText && oddsText !== '---.-' && oddsText !== '**' && oddsText !== '--') {
          odds = parseFloat(oddsText) || 0;
        }
        
        if (popularityText && popularityText !== '**' && popularityText !== '--' && popularityText !== '') {
          popularity = parseInt(popularityText) || 0;
        }
        
        if (horseName) {
          horses.push({
            frameNumber, horseNumber, name: horseName,
            sex: sexAge.match(/([牡牝セ])/)?.[1] || '',
            age: parseInt(sexAge.match(/(\d+)/)?.[1]) || 0,
            weight, jockey, odds, popularity
          });
        }
      }
    });
    
    // データをJSONに変換してクリップボードにコピー
    const data = { raceTitle, raceData01, raceData02, horses };
    navigator.clipboard.writeText(JSON.stringify(data)).then(() => {
      alert(`データを抽出しました！\nレース: ${raceTitle}\n馬数: ${horses.length}頭\n\nクリップボードにコピーしたので、アプリで貼り付けてください。`);
    });
    
  } catch (error) {
    alert('データ抽出に失敗しました: ' + error.message);
  }
})();
      </div>
    </details>

    <h2>🐛 トラブルシューティング</h2>
    
    <h3>データが取得できない場合</h3>
    <ul>
      <li>netkeibaの出馬表ページで実行していることを確認してください</li>
      <li>ページが完全に読み込まれてから実行してください</li>
      <li>ブラウザのJavaScriptが有効になっていることを確認してください</li>
    </ul>

    <h3>クリップボードにコピーされない場合</h3>
    <ul>
      <li>ブラウザがクリップボードアクセスを許可していることを確認してください</li>
      <li>HTTPS接続で動作することを確認してください</li>
    </ul>

    <div class="back-link">
      <a href="/race-db-app/">← Race DB Appに戻る</a>
    </div>
  </div>
</body>
</html>